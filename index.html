<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageInput');
    const output = document.getElementById('output');
    const undoButton = document.getElementById('undoButton');
    const toggleModeButton = document.getElementById('toggleModeButton');
    const horizontalModeButton = document.getElementById('horizontalModeButton');

    let image = new Image();
    let isDrawing = false;
    let startX = null;
    let startY = null;
    let lines = [];
    let labels = [];
    let baseLineLength = null;
    let totalLength = 0;
    let isContinuousMode = false;
    let isHorizontalMode = false;
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let currentLabel = null;

    // 画像が選択されたときに表示する
    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function (e) {
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            alert('画像ファイルを選択してください！');
        }
    });

    // 画像をCanvasに描画する
    image.onload = () => {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0); // 画像を描画
        redraw(); // 他の線を再描画
    };

    // 再描画関数
    function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);

        lines.forEach(line => {
            ctx.beginPath();
            ctx.moveTo(line.x1, line.y1);
            ctx.lineTo(line.x2, line.y2);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
        });
    }
</script>
